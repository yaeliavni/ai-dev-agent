name: Agent Code (Diff -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  run-agent:
    if: contains(github.event.comment.body, '@agent-code')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies (best-effort)
        run: |
          if [ -f package.json ]; then
            pnpm install --frozen-lockfile || pnpm install
          else
            echo "No package.json found. Skipping dependency install."
          fi

      - name: Call AI Agent (request unified diff)
        id: agent
        env:
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_KEY: ${{ secrets.AI_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -z "${AI_KEY:-}" ]; then
            echo "AI_KEY not set. Skipping agent call."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          cat > call-agent.mjs <<'MJS'
          import { writeFileSync, readFileSync, readdirSync } from "node:fs";
          import { join } from "node:path";

          const apiKey = process.env.AI_KEY;
          const baseUrl = process.env.AI_BASE_URL;
          const model = process.env.AI_MODEL;

          // Gather repository context
          function gatherContext() {
            const context = [];
            
            try {
              // Add file tree (limit depth)
              const files = readdirSync(".", { recursive: true, withFileTypes: true })
                .filter(d => !d.name.startsWith(".") && !d.name.includes("node_modules"))
                .slice(0, 100)
                .map(d => d.isDirectory() ? `${d.name}/` : d.name);
              
              context.push("Repository structure:");
              context.push(files.join("\n"));
            } catch (e) {
              context.push("(Could not read repository structure)");
            }

            return context.join("\n");
          }

          const repoContext = gatherContext();

          const system =
            "You are a senior software engineer making targeted code changes. " +
            "You MUST output ONLY a valid unified diff in git format. " +
            "Requirements:\n" +
            "- Start with 'diff --git a/filename b/filename'\n" +
            "- Include '--- a/filename' and '+++ b/filename' headers\n" +
            "- Use proper hunk headers: @@ -start,count +start,count @@\n" +
            "- Lines starting with '-' are removed, '+' are added, ' ' (space) are context\n" +
            "- NO markdown, NO explanations, NO code fences (```), NO preamble\n" +
            "- If no changes needed, output exactly: NO_CHANGES\n" +
            "- For new files, use '--- /dev/null' and '+++ b/filename'\n" +
            "- Ensure proper line endings (LF only, no CRLF)";

          const user =
            `Repository: ${process.env.REPO}\n` +
            `Issue: #${process.env.ISSUE_NUMBER}\n\n` +
            `${repoContext}\n\n` +
            `User request:\n${process.env.COMMENT_BODY}\n\n` +
            `Generate a unified diff patch that implements this request. ` +
            `Remember: output ONLY the diff or NO_CHANGES.`;

          const payload = {
            model,
            messages: [
              { role: "system", content: system },
              { role: "user", content: user },
            ],
            temperature: 0.3,
          };

          const res = await fetch(`${baseUrl}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiKey}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const text = await res.text();
          if (!res.ok) {
            console.error("AI API error:", res.status, text.slice(0, 2000));
            process.exit(1);
          }

          let data;
          try {
            data = JSON.parse(text);
          } catch {
            console.error("Failed to parse JSON:", text.slice(0, 2000));
            process.exit(1);
          }

          let content = data?.choices?.[0]?.message?.content || "NO_CHANGES";
          
          // Clean the content
          content = content
            .replace(/\r\n/g, "\n")  // Normalize line endings
            .replace(/^```[a-z]*\n/gm, "")  // Remove markdown code fences
            .replace(/\n```$/gm, "")
            .trim();

          writeFileSync("agent.patch", content + "\n", "utf8");
          
          // Debug output
          console.log("Generated patch (first 50 lines):");
          console.log(content.split("\n").slice(0, 50).join("\n"));
          MJS

          node call-agent.mjs

      - name: Validate and apply patch
        id: apply
        run: |
          set -euo pipefail

          if [ ! -f agent.patch ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CONTENT="$(cat agent.patch | sed -e 's/[[:space:]]\+$//')"

          # Check for NO_CHANGES
          if [ "$CONTENT" = "NO_CHANGES" ] || [ "$CONTENT" = "NO_CHANGES." ]; then
            echo "Agent reported no changes needed."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Validate it's a unified diff
          if ! echo "$CONTENT" | head -n 10 | grep -Eq '^(diff --git |--- |\+\+\+ )'; then
            echo "ERROR: Model output is not a valid unified diff."
            echo "Expected format: diff --git a/file b/file"
            echo ""
            echo "Actual output (first 80 lines):"
            echo "$CONTENT" | head -n 80
            echo ""
            echo "HINT: The model may need a clearer prompt or different temperature setting."
            exit 1
          fi

          # Additional validation: check for proper hunk headers
          if ! echo "$CONTENT" | grep -Eq '^@@.*@@'; then
            echo "ERROR: Patch missing hunk headers (@@)"
            echo "Output:"
            echo "$CONTENT" | head -n 80
            exit 1
          fi

          echo "Patch validation passed. Applying..."
          echo ""
          
          # Try to apply the patch
          if git apply --check --verbose agent.patch 2>&1; then
            git apply --whitespace=fix agent.patch
          else
            echo ""
            echo "ERROR: Patch failed validation. Full patch content:"
            cat agent.patch
            exit 1
          fi

          # Check if anything actually changed
          if git diff --quiet; then
            echo "Patch applied but resulted in no changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "changed=true" >> "$GITHUB_OUTPUT"
          
          # Show what changed
          echo ""
          echo "Changes applied:"
          git diff --stat

      - name: Lint
        if: steps.apply.outputs.changed == 'true' && hashFiles('package.json') != ''
        run: pnpm lint || true

      - name: Test
        if: steps.apply.outputs.changed == 'true' && hashFiles('package.json') != ''
        run: pnpm test || true

      - name: Build
        if: steps.apply.outputs.changed == 'true' && hashFiles('package.json') != ''
        run: pnpm build || true

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f call-agent.mjs
          rm -f agent.patch

      - name: Create Pull Request
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "agent-code: apply changes for #${{ github.event.issue.number }}"
          title: "agent-code: #${{ github.event.issue.number }}"
          body: |
            ## AI Agent Changes
            
            **Triggered by:** @agent-code comment in issue #${{ github.event.issue.number }}
            
            **Original request:**
            ```
            ${{ github.event.comment.body }}
            ```
            
            **Model used:** ${{ secrets.AI_MODEL }}
            
            ---
            
            This PR was automatically generated by the agent-code workflow.
            Please review the changes carefully before merging.
          branch: agent-code-${{ github.event.issue.number }}-${{ github.run_id }}
          delete-branch: true
