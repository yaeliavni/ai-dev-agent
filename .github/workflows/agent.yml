name: Agent Code (Diff -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  run-agent:
    # Only runs if the comment contains @agent-code
    if: contains(github.event.comment.body, '@agent-code')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          if [ ! -f package.json ]; then
            echo '{"name":"agent-project"}' > package.json
          fi
          pnpm install

      - name: Call AI Agent
        id: agent
        env:
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_KEY: ${{ secrets.AI_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          cat > call-agent.mjs <<'MJS'
          import { writeFileSync } from "node:fs";
          
          const apiKey = process.env.AI_KEY;
          const baseUrl = process.env.AI_BASE_URL;
          const model = process.env.AI_MODEL;

          const res = await fetch(`${baseUrl}/chat/completions`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              messages: [
                { 
                  role: "system", 
                  content: "You are a senior engineer. Output ONLY a raw unified diff patch. No markdown fences, no backticks, no explanations." 
                },
                { role: "user", content: process.env.COMMENT_BODY }
              ],
              temperature: 0.2
            }),
          });

          const data = await res.json();
          let content = data?.choices?.[0]?.message?.content || "NO_CHANGES";
          
          // CLEANING: This removes markdown fences (```diff) that cause the 'corrupt patch' error
          content = content.replace(/```[a-z]*\n/g, "").replace(/```/g, "").trim();
          
          writeFileSync("agent.patch", content + "\n", "utf8");
          MJS
          node call-agent.mjs

      - name: Apply patch
        id: apply
        run: |
          if [ ! -f agent.patch ] || [ "$(cat agent.patch)" = "NO_CHANGES" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            # --3way and --whitespace=fix make the agent much more resilient to AI formatting
            if git apply --3way --whitespace=fix agent.patch; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "Patch failed to apply cleanly."
              exit 1
            fi
          fi

      - name: Cleanup
        if: always()
        run: rm -f call-agent.mjs agent.patch

      - name: Create Pull Request
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "agent-code: update from #${{ github.event.issue.number }}"
          title: "agent-code: changes for #${{ github.event.issue.number }}"
          body: "Applied AI patch based on request: ${{ github.event.comment.body }}"
          branch: agent-code-${{ github.event.issue.number }}
          delete-branch: true
