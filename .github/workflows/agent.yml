name: Agent Code (Diff -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  run-agent:
    if: contains(github.event.comment.body, '@agent-code')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          if [ ! -f package.json ]; then
            echo '{"name":"agent-demo","scripts":{"lint":"echo skip","test":"echo skip","build":"echo skip"}}' > package.json
          fi
          pnpm install

      - name: Call MiniMax (With Demo Fallback)
        id: minimax
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -z "$MINIMAX_API_KEY" ]; then
            echo "DEBUG: No API Key found. Generating a Demo Patch."
            cat > agent_output.txt <<'EOF'
          diff --git a/README.md b/README.md
          --- a/README.md
          +++ b/README.md
          @@ -1,2 +1,5 @@
           # Project
          -This is a placeholder.
          +This project features an Automated AI Agent.
          +### Capabilities
          +- Automatic PR Generation
          +- Built-in Safety Gates
          EOF
          else
            echo "API Key detected. Running real AI logic..."
            cat > call-agent.mjs <<'MJS'
          import { writeFileSync } from "node:fs";
          const apiKey = process.env.MINIMAX_API_KEY;
          const payload = {
            model: "MiniMax-M2.1",
            messages: [
              { role: "system", content: "Output MUST be a single unified diff patch only. No markdown." },
              { role: "user", content: process.env.COMMENT_BODY }
            ],
          };
          const res = await fetch("https://api.minimax.io/v1/chat/completions", {
            method: "POST",
            headers: { 
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json" 
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          const content = data?.choices?.[0]?.message?.content || "NO_CHANGES";
          writeFileSync("agent_output.txt", content, "utf8");
          MJS
            node call-agent.mjs
          fi
          echo "ai_output_path=agent_output.txt" >> $GITHUB_OUTPUT

      - name: Apply patch
        id: apply
        run: |
          set -euo pipefail
          OUT="${{ steps.minimax.outputs.ai_output_path }}"
          
          # FOR DEMO ONLY: If it's the demo text, just force-write it to README
          if grep -q "This project features an Automated AI Agent" "$OUT"; then
            echo "Forcing Demo Update to README.md"
            cat "$OUT" > README.md
            echo "changed=true" >> $GITHUB_OUTPUT
          # Otherwise, try the professional git apply logic
          elif grep -q "diff --git" "$OUT"; then
            git apply --whitespace=fix "$OUT"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "No valid changes found."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "agent-code: applied suggested changes"
          title: "agent-code: Demo Update for #${{ github.event.issue.number }}"
          body: |
            ### Agent Status: Ready 
            This PR was generated using the **Demo Fallback**. 
            To enable real AI updates, please add the `MINIMAX_API_KEY` to the repository secrets.
          branch: agent-demo-${{ github.run_id }}
          delete-branch: true
