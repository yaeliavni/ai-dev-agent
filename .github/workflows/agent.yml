name: Agent Code (Diff -> PR)
on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  run-agent:
    if: contains(github.event.comment.body, '@agent-code')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          if [ ! -f package.json ]; then
            echo '{"name":"agent-demo","scripts":{"lint":"echo skip","test":"echo skip","build":"echo skip"}}' > package.json
          fi
          pnpm install

      - name: Call MiniMax (With Demo Fallback)
        id: minimax
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          if [ -z "$MINIMAX_API_KEY" ]; then
            echo "Generating Clean Demo Content..."
            echo "# AI-Enhanced Repository" > clean_readme.txt
            echo "This project features a GitHub Action Agent." >> clean_readme.txt
            echo "Status: API Key Pending." >> clean_readme.txt
          else
            cat > call-agent.mjs <<'MJS'
          import { writeFileSync } from "node:fs";
          const res = await fetch("https://api.minimax.io/v1/chat/completions", {
            method: "POST",
            headers: { 
              "Authorization": `Bearer ${process.env.MINIMAX_API_KEY}`,
              "Content-Type": "application/json" 
            },
            body: JSON.stringify({
              model: "MiniMax-M2.1",
              messages: [{ role: "user", content: process.env.COMMENT_BODY }]
            })
          });
          const data = await res.json();
          writeFileSync("clean_readme.txt", data.choices?.[0]?.message?.content || "NO_CHANGES");
          MJS
            node call-agent.mjs
          fi

      - name: Finalize Project Files
        run: |
          # Overwrite README with the result
          cat clean_readme.txt > README.md
          
          # CRITICAL: Delete temporary scripts so they aren't committed to the PR
          rm -f call-agent.mjs
          rm -f clean_readme.txt
          rm -f pnpm-lock.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "agent-code: professional update"
          title: "agent-code: AI Suggestion for README"
          body: "Verified workflow. Ready for API Key activation."
          branch: agent-final-demo
          delete-branch: true
