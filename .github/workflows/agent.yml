name: Agent Code (Multi-Format Testing)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  # JOB 1: THE NEW ROBUST METHOD (Full Overwrite)
  run-overwrite-agent:
    if: contains(github.event.comment.body, '@agent-code')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Call AI (Full Files)
        id: agent
        env:
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_KEY: ${{ secrets.AI_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          cat > call-agent.mjs <<'MJS'
          import { writeFileSync } from "node:fs";
          const system = "You are a senior code agent. Output changes in format: FILE: path/to/file.ext\nCONTENT:\n[Full file content]\nEND_FILE\nNO markdown, NO explanations.";
          const user = `Repo: ${process.env.REPO}\nIssue: #${process.env.ISSUE_NUMBER}\nRequest:\n${process.env.COMMENT_BODY}`;
          const res = await fetch(`${process.env.AI_BASE_URL}/chat/completions`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${process.env.AI_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: process.env.AI_MODEL, messages: [{role:"system", content:system}, {role:"user", content:user}], temperature: 0.1 }),
          });
          const data = await res.json();
          writeFileSync("agent.output", data?.choices?.[0]?.message?.content || "", "utf8");
          MJS
          node call-agent.mjs

      - name: Apply changes (Full Overwrite)
        id: apply
        run: |
          if [ ! -f agent.output ]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          awk '/^FILE: / { file=$2; split(file, parts, "/"); dir=""; for (i=1; i<length(parts); i++) { dir = (dir == "" ? parts[i] : dir "/" parts[i]); } if (dir != "") system("mkdir -p " dir); next } /^CONTENT:/ { writing=1; next } /^END_FILE/ { writing=0; close(file); next } writing { print $0 > file }' agent.output
          rm -f call-agent.mjs agent.output pnpm-lock.yaml
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if [ -n "$(git status --porcelain)" ]; then echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi

      - name: Create Pull Request
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "agent-overwrite: apply changes for #${{ github.event.issue.number }}"
          title: "Overwrite Suggestion for #${{ github.event.issue.number }}"
          branch: agent-overwrite-${{ github.event.issue.number }}

  # JOB 2: THE ORIGINAL DIFF METHOD
  run-diff-agent:
    if: contains(github.event.comment.body, '@agent-diff')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Call AI (Unified Diff)
        id: agent
        env:
          AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_KEY: ${{ secrets.AI_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          cat > call-agent.mjs <<'MJS'
          import { writeFileSync } from "node:fs";
          const system = "You are a senior code-change agent. Output a valid unified diff in git format. NO markdown fences.";
          const user = `Request: ${process.env.COMMENT_BODY}`;
          const res = await fetch(`${process.env.AI_BASE_URL}/chat/completions`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${process.env.AI_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ model: process.env.AI_MODEL, messages: [{role:"system", content:system}, {role:"user", content:user}], temperature: 0.1 }),
          });
          const data = await res.json();
          writeFileSync("agent.patch", data?.choices?.[0]?.message?.content || "", "utf8");
          MJS
          node call-agent.mjs

      - name: Apply patch
        id: apply
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git apply --3way --ignore-whitespace --recount agent.patch || true
          rm -f agent.patch call-agent.mjs
          git add .
          if [ -n "$(git status --porcelain)" ]; then echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi

      - name: Create Pull Request
        if: steps.apply.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Diff Suggestion for #${{ github.event.issue.number }}"
          branch: agent-diff-${{ github.event.issue.number }}
